# Second Treatment | Day 30
# 22cm 

from openalea.plantgl.all import *
from math import * 

module Leaf

length = 5   # in some units (= cm for example)
dl = 0.01
### to dilate/contract the leaf ###
scaling = 3   # to d
midrib_separation = 10
branch_angle = 45
base_leaf_area = 2.672 # Constant

phi = 180      # Phyllotactic angle
h = 1     # height of an internode
L_ungrownstem = 4
L0_ungrownstem = 4


#####
# Treatment ---- Day ---- Avg. Length --- Leaf Area
#       T1  ---- 30 ---- 22.6 cm ---- 3.940 cm
####
# Axiom: F!(0.05)F[-(20)FFF-(10)@Dd(1)A(1)][+(20)FFF@Dd(1)A(2)]FFFFFFF+(20)[-F@Dd(1)B(1)]+(20)
Axiom: !(0.05)Stem_first_internode[Branch_first_leftA(1)][Branch_first_rightA(1)]FFFFFFFFA(1)
# Todo: make ungrown stem have its own module

derivation length: 1
production:

Stem_first_internode:
  produce FFFFFFFF
Branch_first_left:
  produce -(branch_angle)FF
Branch_first_right:
  produce +(branch_angle)FF
  
Info:
  produce [@M(0,10,10) Label('TREATMENT 4 -- DAY 30')]

A(leaf_area):
  produce [^(20)Leaf(scaling, leaf_area)] 
  
B(n):
  produce [^(20)Leaf_single(scaling)] 
 
interpretation:

Leaf(x, leaf_area) --> ;(2)_(0.05)F(0.1)[+(midrib_separation/(leaf_area/base_leaf_area))@Di(leaf_area)Sweep(nerve,section,length,dl,x,width_left)][/-(midrib_separation/(leaf_area/base_leaf_area))@Di(leaf_area)Sweep(nerve,section,length,dl,x,width_right)]

Leaf_single(x) --> ;(2)_(0.05)F(0.1)[Sweep(nerve,section_single,length,dl,x,width_single)]

A(n) --> ;(2) @O(0.2)
B(n) --> ;(2) @O(0.2)




endlsystem
###### INITIALISATION ######

__lpy_code_version__ = 1.1

def __initialiseContext__(context):
	import openalea.plantgl.all as pgl
	Color_1 = pgl.Material("Color_1" , ambient = (111,126,33) , diffuse = 1.42857 , )
	Color_1.name = "Color_1"
	context.turtle.setMaterial(1,Color_1)
	Color_2 = pgl.Material("Color_2" , ambient = (66,92,5) , diffuse = 1.95652 , shininess = 0.26 , )
	Color_2.name = "Color_2"
	context.turtle.setMaterial(2,Color_2)
	import openalea.plantgl.all as pgl
	width_left = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(0, 0.0311929, 1),(0.0991906, 0.222846, 1),(0.200979, 0.159086, 1),(0.648978, 0.184865, 1),(0.854868, 0.107171, 1),(1, 0.0243861, 1)]) , 
	    stride = 36 , 
	    )
	width_left.name = "width_left"
	import openalea.plantgl.all as pgl
	nerve = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(-0.5, 0, 1),(-0.244461, 0.0372671, 1),(0.121756, -0.029734, 1),(0.451834, -0.0107819, 1)]) , 
	    )
	nerve.name = "nerve"
	section = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(-0.5, 0, 1),(-0.29979, -0.110154, 1),(-0.0622408, 0.139037, 1),(0.5, 0, 1)]) , 
	    stride = 34 , 
	    )
	section.name = "section"
	width_right = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(0, 0.0311929, 1),(0.103633, 0.0345376, 1),(0.200979, 0.159086, 1),(0.648978, 0.184865, 1),(0.854868, 0.107171, 1),(1, 0.0243861, 1)]) , 
	    stride = 36 , 
	    )
	width_right.name = "width_right"
	width_single = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(0, 0.0368034, 1),(0.321038, 0.20082, 1),(0.674863, 0.127049, 1),(1, 0.00418017, 1)]) , 
	    )
	width_single.name = "width_single"
	nerve_single = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(-0.5, 0, 1),(-0.223915, 0.114315, 1),(0.121756, 0.0370409, 1),(0.467244, -0.216243, 1)]) , 
	    )
	nerve_single.name = "nerve_single"
	section_single = pgl.NurbsCurve2D(	
	    ctrlPointList = pgl.Point3Array([(-0.5, 0, 1),(-0.205628, -0.122263, 1),(0.116005, 0.197415, 1),(0.5, 0, 1)]) , 
	    )
	section_single.name = "section_single"
	c0_ungrown_stem = pgl.BezierCurve2D(	
	    pgl.Point3Array([(-0.5, 0, 1),(-0.380963, -0.180649, 1),(-0.0534684, -0.0188563, 1),(0.0171664, 0.107867, 1)]) , 
	    )
	c0_ungrown_stem.name = "c0_ungrown_stem"
	panel_0 = ({'name': 'Panel 1', 'active': True, 'visible': True},[('Function',width_left),('Curve2D',nerve),('Curve2D',section),('Function',width_right),('Function',width_single),('Curve2D',nerve_single),('Curve2D',section_single),('Curve2D',c0_ungrown_stem)])
	parameterset = [panel_0,]
	context["__functions__"] = [('width_left',width_left),('width_right',width_right),('width_single',width_single),]
	context["__curves__"] = [('nerve',nerve),('section',section),('nerve_single',nerve_single),('section_single',section_single),('c0_ungrown_stem',c0_ungrown_stem),]
	context["__parameterset__"] = parameterset
	context["width_left"] = pgl.QuantisedFunction(width_left)
	context["nerve"] = nerve
	context["section"] = section
	context["width_right"] = pgl.QuantisedFunction(width_right)
	context["width_single"] = pgl.QuantisedFunction(width_single)
	context["nerve_single"] = nerve_single
	context["section_single"] = section_single
	context["c0_ungrown_stem"] = c0_ungrown_stem
